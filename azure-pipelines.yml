# Copyright (c) 2025 Vladimir Gusarov. All rights reserved.
# Licensed under the MIT License.
#
# Azure Pipeline: Template Testing and Validation
#
# This pipeline validates all templates in the /pipelines/lib directory to ensure:
# - YAML syntax is valid
# - Templates have proper structure
# - Required parameters are defined
# - Templates can be successfully expanded
#
# Runs on:
# - Pull requests to main branch
# - Commits to main branch
# - Manual triggers

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - pipelines/lib/*.yml
      - scripts/*.ps1
      - azure-pipelines.yml

pr:
  branches:
    include:
      - main
  paths:
    include:
      - pipelines/lib/*.yml
      - scripts/*.ps1
      - azure-pipelines.yml

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Path to the templates directory
  templatesPath: 'pipelines/lib'

stages:
  - stage: ValidateTemplates
    displayName: 'Validate Pipeline Templates'
    jobs:
      - job: YAMLSyntaxValidation
        displayName: 'YAML Syntax Validation'
        steps:
          - checkout: self
            displayName: 'Checkout repository'

          - task: PowerShell@2
            displayName: 'Install yamllint'
            inputs:
              targetType: 'inline'
              script: |
                pip install yamllint
                yamllint --version
              pwsh: true

          - task: PowerShell@2
            displayName: 'Validate YAML syntax for all templates'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'

                Write-Host "Validating YAML syntax for templates in $(templatesPath)..."
                $templates = Get-ChildItem -Path "$(templatesPath)" -Filter "*.yml"

                $failedFiles = @()
                foreach ($template in $templates) {
                    Write-Host "##[group]Validating $($template.Name)"
                    try {
                        # Use yamllint to validate YAML syntax
                        $result = & yamllint -d relaxed $template.FullName 2>&1
                        if ($LASTEXITCODE -ne 0) {
                            Write-Host "##[error]YAML syntax validation failed for $($template.Name)"
                            Write-Host $result
                            $failedFiles += $template.Name
                        } else {
                            Write-Host "✓ YAML syntax is valid for $($template.Name)"
                        }
                    } catch {
                        Write-Host "##[error]Error validating $($template.Name): $_"
                        $failedFiles += $template.Name
                    }
                    Write-Host "##[endgroup]"
                }

                if ($failedFiles.Count -gt 0) {
                    Write-Host "##[error]YAML validation failed for: $($failedFiles -join ', ')"
                    exit 1
                }

                Write-Host "##[section]All templates passed YAML syntax validation"
              pwsh: true

      - job: TemplateStructureValidation
        displayName: 'Template Structure Validation'
        dependsOn: YAMLSyntaxValidation
        steps:
          - checkout: self
            displayName: 'Checkout repository'

          - task: PowerShell@2
            displayName: 'Install powershell-yaml module'
            inputs:
              targetType: 'inline'
              script: |
                Install-Module -Name powershell-yaml -Force -Scope CurrentUser
                Import-Module powershell-yaml
              pwsh: true

          - task: PowerShell@2
            displayName: 'Validate template structure'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                Import-Module powershell-yaml

                Write-Host "Validating template structure for templates in $(templatesPath)..."
                $templates = Get-ChildItem -Path "$(templatesPath)" -Filter "*.yml"

                $validationErrors = @()

                foreach ($template in $templates) {
                    Write-Host "##[group]Validating structure of $($template.Name)"

                    try {
                        # Read and parse YAML
                        $content = Get-Content -Path $template.FullName -Raw
                        $yaml = ConvertFrom-Yaml $content

                        # Check if template has required top-level keys
                        $hasParameters = $yaml.ContainsKey('parameters')
                        $hasSteps = $yaml.ContainsKey('steps')

                        if (-not $hasParameters -and -not $hasSteps) {
                            $validationErrors += "$($template.Name): Template must have either 'parameters' or 'steps' section"
                            Write-Host "##[error]Template is missing required sections"
                        }

                        # Validate parameters section if present
                        if ($hasParameters) {
                            if ($null -ne $yaml.parameters) {
                                $paramCount = $yaml.parameters.Count
                                Write-Host "  ✓ Found $paramCount parameter(s)"

                                foreach ($param in $yaml.parameters) {
                                    # Handle both hashtable and PSCustomObject parameter structures
                                    $paramName = if ($param -is [hashtable]) { $param['name'] } else { $param.name }
                                    if ([string]::IsNullOrEmpty($paramName)) {
                                        $validationErrors += "$($template.Name): Parameter is missing 'name' property"
                                    } else {
                                        Write-Host "    - Parameter: $paramName"
                                    }
                                }
                            } else {
                                Write-Host "  ⚠ Parameters section exists but is empty"
                            }
                        }

                        # Validate steps section if present
                        if ($hasSteps) {
                            if ($null -ne $yaml.steps) {
                                $stepCount = $yaml.steps.Count
                                Write-Host "  ✓ Found $stepCount step(s)"
                            } else {
                                Write-Host "  ⚠ Steps section exists but is empty"
                            }
                        }

                        Write-Host "✓ Structure validation passed for $($template.Name)"
                    } catch {
                        $validationErrors += "$($template.Name): $_"
                        Write-Host "##[error]Error parsing template: $_"
                    }

                    Write-Host "##[endgroup]"
                }

                if ($validationErrors.Count -gt 0) {
                    Write-Host "##[error]Template structure validation failed:"
                    foreach ($error in $validationErrors) {
                        Write-Host "##[error]  - $error"
                    }
                    exit 1
                }

                Write-Host "##[section]All templates passed structure validation"
              pwsh: true

      - job: TemplateExpansionTest
        displayName: 'Template Expansion Test'
        dependsOn: TemplateStructureValidation
        steps:
          - checkout: self
            displayName: 'Checkout repository'

          - task: PowerShell@2
            displayName: 'Test template expansion with Azure Pipelines CLI'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'

                Write-Host "Testing template expansion for templates in $(templatesPath)..."
                Write-Host "Note: This validation ensures templates can be referenced and expanded in pipelines"

                # Create test pipelines for each template to verify they can be expanded
                $templates = Get-ChildItem -Path "$(templatesPath)" -Filter "*.yml"

                Write-Host "##[section]Found $($templates.Count) template(s) to validate:"
                foreach ($template in $templates) {
                    Write-Host "  - $($template.Name)"
                }

                # Validate that all templates exist and are readable
                $missingTemplates = @()
                foreach ($template in $templates) {
                    if (-not (Test-Path $template.FullName)) {
                        $missingTemplates += $template.Name
                    }
                }

                if ($missingTemplates.Count -gt 0) {
                    Write-Host "##[error]Missing templates: $($missingTemplates -join ', ')"
                    exit 1
                }

                Write-Host "##[section]All templates are accessible and ready for expansion"
              pwsh: true

      - job: ScriptValidation
        displayName: 'PowerShell Script Validation'
        steps:
          - checkout: self
            displayName: 'Checkout repository'

          - task: PowerShell@2
            displayName: 'Run PSScriptAnalyzer on PowerShell scripts'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'

                # Install PSScriptAnalyzer
                Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
                Import-Module PSScriptAnalyzer

                Write-Host "Running PSScriptAnalyzer on scripts..."
                $scripts = Get-ChildItem -Path "scripts" -Filter "*.ps1" -Recurse

                $allResults = @()
                foreach ($script in $scripts) {
                    Write-Host "##[group]Analyzing $($script.Name)"
                    $results = Invoke-ScriptAnalyzer -Path $script.FullName -Severity Warning,Error

                    if ($results) {
                        $allResults += $results
                        foreach ($result in $results) {
                            $message = "$($result.Severity): $($result.Message) at line $($result.Line)"
                            if ($result.Severity -eq 'Error') {
                                Write-Host "##[error]$message"
                            } else {
                                Write-Host "##[warning]$message"
                            }
                        }
                    } else {
                        Write-Host "✓ No issues found in $($script.Name)"
                    }
                    Write-Host "##[endgroup]"
                }

                # Fail if there are errors
                $errors = $allResults | Where-Object { $_.Severity -eq 'Error' }
                if ($errors.Count -gt 0) {
                    Write-Host "##[error]Found $($errors.Count) error(s) in PowerShell scripts"
                    exit 1
                }

                Write-Host "##[section]PowerShell script validation completed successfully"
              pwsh: true

  - stage: IntegrationTests
    displayName: 'Template Integration Tests'
    dependsOn: ValidateTemplates
    jobs:
      - job: TestTemplateIntegration
        displayName: 'Test Template Integration'
        steps:
          - checkout: self
            displayName: 'Checkout repository'

          - task: PowerShell@2
            displayName: 'Verify template dependencies'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'

                Write-Host "Verifying template dependencies and cross-references..."

                # Check that templates referencing other templates can find them
                $bicepTemplate = Get-Content -Path "$(templatesPath)/bicep-deploy.yml" -Raw
                $runTestsTemplate = Get-Content -Path "$(templatesPath)/run-acceptance-tests.yml" -Raw

                # Verify bicep-deploy references azure-cli
                if ($bicepTemplate -match "-\s+template:\s+azure-cli\.yml") {
                    Write-Host "✓ bicep-deploy.yml correctly references azure-cli.yml"
                } else {
                    Write-Host "##[error]bicep-deploy.yml does not reference azure-cli.yml correctly"
                    exit 1
                }

                # Verify run-acceptance-tests references azure-cli
                if ($runTestsTemplate -match "-\s+template:\s+azure-cli\.yml") {
                    Write-Host "✓ run-acceptance-tests.yml correctly references azure-cli.yml"
                } else {
                    Write-Host "##[error]run-acceptance-tests.yml does not reference azure-cli.yml correctly"
                    exit 1
                }

                Write-Host "##[section]All template dependencies verified successfully"
              pwsh: true

          - task: PowerShell@2
            displayName: 'Verify template documentation'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'

                Write-Host "Verifying template documentation..."

                # Check that README exists and documents all templates
                $readmePath = "$(templatesPath)/README.md"
                if (-not (Test-Path $readmePath)) {
                    Write-Host "##[error]README.md not found in templates directory"
                    exit 1
                }

                $readme = Get-Content -Path $readmePath -Raw
                $templates = Get-ChildItem -Path "$(templatesPath)" -Filter "*.yml"

                $undocumentedTemplates = @()
                foreach ($template in $templates) {
                    $templateName = $template.Name
                    if ($readme -notmatch $templateName) {
                        $undocumentedTemplates += $templateName
                    } else {
                        Write-Host "✓ $templateName is documented in README.md"
                    }
                }

                if ($undocumentedTemplates.Count -gt 0) {
                    Write-Host "##[warning]The following templates are not documented in README.md:"
                    foreach ($template in $undocumentedTemplates) {
                        Write-Host "##[warning]  - $template"
                    }
                }

                Write-Host "##[section]Template documentation verification completed"
              pwsh: true

  - stage: ReportResults
    displayName: 'Report Test Results'
    dependsOn:
      - ValidateTemplates
      - IntegrationTests
    condition: always()
    jobs:
      - job: SummaryReport
        displayName: 'Generate Test Summary'
        steps:
          - task: PowerShell@2
            displayName: 'Generate validation summary'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "##[section]Template Validation Summary"
                Write-Host ""
                Write-Host "Pipeline validation completed for all templates in $(templatesPath)"
                Write-Host ""
                Write-Host "Validation stages:"
                Write-Host "  ✓ YAML Syntax Validation"
                Write-Host "  ✓ Template Structure Validation"
                Write-Host "  ✓ Template Expansion Test"
                Write-Host "  ✓ PowerShell Script Validation"
                Write-Host "  ✓ Template Integration Tests"
                Write-Host ""
                Write-Host "All templates are ready for use in Azure DevOps pipelines!"
              pwsh: true
