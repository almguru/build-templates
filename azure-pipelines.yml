# Copyright (c) 2025 Vladimir Gusarov. All rights reserved.
# Licensed under the MIT License.
#
# Azure Pipeline: Template Testing
#
# This pipeline tests all templates in the /pipelines/lib directory by:
# - Actually calling each template with test parameters
# - Verifying templates execute without errors
# - Testing different parameter combinations
#
# Runs on:
# - Pull requests to main branch
# - Commits to main branch
# - Manual triggers

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - pipelines/lib/*.yml
      - scripts/*.ps1
      - azure-pipelines.yml

pr:
  branches:
    include:
      - main
  paths:
    include:
      - pipelines/lib/*.yml
      - scripts/*.ps1
      - azure-pipelines.yml

pool:
  vmImage: 'ubuntu-latest'

stages:
  # Test azure-cli.yml template
  - stage: TestAzureCLI
    displayName: 'Test azure-cli.yml Template'
    jobs:
      - job: TestBashScript
        displayName: 'Test with Bash script'
        steps:
          - checkout: self

          - template: pipelines/lib/azure-cli.yml
            parameters:
              azureSubscription: ''
              script:
                type: 'bash'
                location: 'inlineScript'
                script: |
                  echo "Testing azure-cli template with bash script"
                  echo "Template execution successful"
                displayName: 'Test Bash Script Execution'

      - job: TestPowerShellScript
        displayName: 'Test with PowerShell Core script'
        steps:
          - checkout: self

          - template: pipelines/lib/azure-cli.yml
            parameters:
              azureSubscription: ''
              defaultScriptType: 'pscore'
              script:
                script: |
                  Write-Host "Testing azure-cli template with PowerShell Core script"
                  Write-Host "Template execution successful"
                displayName: 'Test PowerShell Core Script Execution'

      - job: TestWithEnvironmentVariables
        displayName: 'Test with environment variables'
        steps:
          - checkout: self

          - template: pipelines/lib/azure-cli.yml
            parameters:
              azureSubscription: ''
              script:
                type: 'bash'
                location: 'inlineScript'
                script: |
                  echo "Testing with environment variables"
                  echo "TEST_VAR: $TEST_VAR"
                  echo "ANOTHER_VAR: $ANOTHER_VAR"
                displayName: 'Test Environment Variables'
              environment:
                TEST_VAR: 'test-value'
                ANOTHER_VAR: 'another-value'

  # Test use-template-files.yml template
  - stage: TestUseTemplateFiles
    displayName: 'Test use-template-files.yml Template'
    jobs:
      - job: TestCheckout
        displayName: 'Test repository checkout'
        steps:
          - template: pipelines/lib/use-template-files.yml
            parameters:
              repositoryResourceName: 'self'
              repositoryLocalPath: 'template-test'

          - script: |
              echo "Verifying almguruTemplateFilesPath variable was set"
              if [ -z "$(almguruTemplateFilesPath)" ]; then
                echo "##vso[task.logissue type=error]Variable almguruTemplateFilesPath was not set"
                exit 1
              fi
              echo "Variable set to: $(almguruTemplateFilesPath)"
              echo "Template execution successful"
            displayName: 'Verify Variable Setup'

  # Test docker.yml template (dry-run without actual Docker operations)
  - stage: TestDocker
    displayName: 'Test docker.yml Template'
    jobs:
      - job: TestParameterValidation
        displayName: 'Test parameter validation'
        steps:
          - checkout: self

          - script: |
              echo "Creating test Dockerfile"
              mkdir -p /tmp/test-docker
              cat > /tmp/test-docker/Dockerfile << 'EOF'
              FROM alpine:latest
              RUN echo "Test image"
              EOF
            displayName: 'Create Test Dockerfile'

          # Test with missing parameters to verify validation
          - template: pipelines/lib/docker.yml
            parameters:
              containerRegistry: ''
              defaultImageTag: 'test-tag'
              images:
                - name: 'test-image'
                  dockerFile: '/tmp/test-docker/Dockerfile'
                  buildContext: '/tmp/test-docker'
                  repositoryName: ''  # Missing required parameter

          - script: |
              echo "Checking for expected validation error in previous step logs"
              if ! grep -q "repositoryName.*required" "$(System.DefaultWorkingDirectory)/_temp/_log.txt"; then
                echo "##vso[task.logissue type=error]Expected validation error for missing repositoryName not found"
                exit 1
              fi
              echo "Validation error detected as expected"
            displayName: 'Explicit Validation Check'
            continueOnError: false

  # Test PowerShell scripts used by templates
  - stage: TestScripts
    displayName: 'Test PowerShell Scripts'
    jobs:
      - job: TestInvokeTestRunner
        displayName: 'Test Invoke-TestRunner.ps1'
        steps:
          - checkout: self

          - task: PowerShell@2
            displayName: 'Test script with no test files'
            inputs:
              targetType: 'inline'
              script: |
                # Create a test directory with no test files
                $testDir = New-Item -ItemType Directory -Path (Join-Path $env:TEMP "empty-test-dir") -Force

                # This should complete without error when no files are found
                & "$(Build.SourcesDirectory)/scripts/Invoke-TestRunner.ps1" `
                  -SearchPath $testDir.FullName `
                  -FilePattern "**/*Tests.dll" `
                  -ResultsDirectory (Join-Path $env:TEMP "test-results") `
                  -TestRunnerCommand "echo" `
                  -TestResultsArguments "test"

                Write-Host "Script executed successfully with no test files"
              pwsh: true

  # Integration test: Verify all templates are accessible
  - stage: VerifyTemplateAccessibility
    displayName: 'Verify All Templates Are Accessible'
    dependsOn:
      - TestAzureCLI
      - TestUseTemplateFiles
      - TestDocker
      - TestScripts
    jobs:
      - job: ListTemplates
        displayName: 'List and verify all templates'
        steps:
          - checkout: self

          - task: PowerShell@2
            displayName: 'Verify all templates exist'
            inputs:
              targetType: 'inline'
              script: |
                $templates = @(
                  'pipelines/lib/azure-cli.yml',
                  'pipelines/lib/bicep-deploy.yml',
                  'pipelines/lib/docker.yml',
                  'pipelines/lib/run-acceptance-tests.yml',
                  'pipelines/lib/use-template-files.yml'
                )

                Write-Host "##[section]Verifying template files"
                $missingTemplates = @()
                foreach ($template in $templates) {
                    if (Test-Path $template) {
                        Write-Host "✓ Found: $template"
                    } else {
                        Write-Host "##[error]✗ Missing: $template"
                        $missingTemplates += $template
                    }
                }

                if ($missingTemplates.Count -gt 0) {
                    Write-Host "##[error]Missing templates: $($missingTemplates -join ', ')"
                    exit 1
                }

                Write-Host "##[section]All templates verified successfully"
              pwsh: true

  # Summary stage
  - stage: TestSummary
    displayName: 'Test Summary'
    dependsOn:
      - TestAzureCLI
      - TestUseTemplateFiles
      - TestDocker
      - TestScripts
      - VerifyTemplateAccessibility
    condition: always()
    jobs:
      - job: Summary
        displayName: 'Generate test summary'
        steps:
          - task: PowerShell@2
            displayName: 'Display summary'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "##[section]Template Testing Summary"
                Write-Host ""
                Write-Host "Templates tested by actual execution:"
                Write-Host "  ✓ azure-cli.yml - Multiple script types and configurations"
                Write-Host "  ✓ use-template-files.yml - Repository checkout"
                Write-Host "  ✓ docker.yml - Parameter validation"
                Write-Host "  ✓ PowerShell scripts - Invoke-TestRunner.ps1"
                Write-Host ""
                Write-Host "Note: bicep-deploy.yml and run-acceptance-tests.yml require Azure"
                Write-Host "      service connections and are tested in consuming pipelines."
                Write-Host ""
                Write-Host "All tested templates executed successfully!"
              pwsh: true
