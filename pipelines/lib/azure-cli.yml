# Copyright (c) 2025 Vladimir Gusarov. All rights reserved.
# Licensed under the MIT License.
#
# Template: Azure CLI Template
# Description: A reusable template for executing Azure CLI commands in Azure DevOps pipelines.
# This template provides a standardized way to run Azure CLI scripts with configurable script types
# (PowerShell, PowerShell Core, Bash, or Batch) and supports both inline scripts and script files.
#
# Parameters:
# - azureSubscription: The Azure service connection to use
# - defaultDisplayName: Default display name for the task
# - defaultScriptType: Default script type (bash, ps, pscore, batch)
# - script: Object containing script configuration (type, location, script content, arguments, displayName)

parameters:
  # Name of the Azure RM service connection to use for the deployment
  - name: azureSubscription
    type: string
    default: ''

  # Default display name for the Azure CLI task if not specified in the script object
  - name: defaultDisplayName
    type: string
    default: 'Azure CLI script'

  # Default script type to use if not specified in the script object
  # Supported values: 'bash', 'ps', 'pscore', 'batch'
  # - 'bash' for Bash scripts
  # - 'ps' for PowerShell scripts
  # - 'pscore' for PowerShell Core scripts
  # - 'batch' for Batch scripts
  - name: defaultScriptType
    type: string
    default: 'bash'
    values:
      - 'ps' # PowerShell
      - 'pscore' # PowerShell Core
      - 'bash' # Bash
      - 'batch' # Batch file

  # Script configuration object containing:
  # - type: Type of the script (bash, ps, pscore, batch)
  # - location: Location of the script (inlineScript or scriptPath)
  # - script: The script content or path to the script file
  # - arguments: Optional arguments to pass to the script for file scripts
  # - displayName: Optional display name for the task
  # - workingDirectory: Optional working directory for the script execution. Default is `$(System.DefaultWorkingDirectory)`
  # - addSpnToEnvironment: Optional flag to add the service principal to the environment variables. Defaults to false.
  - name: script
    type: object
    default: {}

  # Key-value pairs of environment variables to set during script execution
  - name: environment
    type: object
    default: {}

steps:
  - task: AzureCLI@2
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      scriptType: ${{ coalesce(parameters.script.type, parameters.defaultScriptType) }}
      scriptLocation: ${{ coalesce(parameters.script.location, 'inlineScript') }}
      ${{ if eq(coalesce(parameters.script.location, 'inlineScript'), 'scriptPath') }}:
        ${{ if ne(coalesce(parameters.script.workingDirectory, ''), '') }}:
          scriptPath: ${{ parameters.script.workingDirectory }}/${{ parameters.script.script }}
        ${{ else }}:
          scriptPath: ${{ parameters.script.script }}
      ${{ if eq(coalesce(parameters.script.location, 'inlineScript'), 'inlineScript') }}:
        inlineScript: ${{ parameters.script.script }}
      ${{ if parameters.script.arguments }}:
        arguments: '${{ parameters.script.arguments }}'
      workingDirectory: ${{ coalesce(parameters.script.workingDirectory, '$(System.DefaultWorkingDirectory)') }}
      addSpnToEnvironment: ${{ coalesce(parameters.script.addSpnToEnvironment, false) }}
    ${{ if parameters.environment }}:
      env:
        ${{ each pair in parameters.environment }}:
          ${{ pair.key }}: ${{ pair.value }}
    displayName: ${{ coalesce(parameters.script.displayName, parameters.defaultDisplayName) }}
